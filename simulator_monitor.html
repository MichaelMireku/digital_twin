<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Simulator Monitor</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #ffffff;
            color: #000000;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        h1 { color: #000000; font-size: 1.5rem; word-break: break-word; }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status.connected { background: #000000; color: #ffffff; }
        .status.disconnected { background: #666666; color: #ffffff; }
        .status.connecting { background: #999999; color: #000000; }
        
        .config-panel {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .config-panel h3 { margin-bottom: 15px; color: #000000; }
        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .config-field label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        .config-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #ffffff;
            color: #000000;
            font-size: 0.9rem;
        }
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #000000; color: #ffffff; }
        .btn-primary:hover { background: #333333; }
        .btn-danger { background: #333333; color: #ffffff; }
        .btn-secondary { background: #e0e0e0; color: #000000; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: bold; color: #000000; }
        .stat-label { font-size: 0.8rem; color: #666; margin-top: 5px; }
        
        .log-container {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #e0e0e0;
        }
        .log-header h3 { color: #000000; }
        #log {
            height: 500px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            background: #ffffff;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            background: #f9f9f9;
            border-left: 3px solid #000000;
            animation: fadeIn 0.3s ease;
        }
        .log-entry.level { border-left-color: #000000; }
        .log-entry.temperature { border-left-color: #666666; }
        .log-entry.error { border-left-color: #333333; background: #f0f0f0; }
        .log-time { color: #888; margin-right: 10px; }
        .log-topic { color: #000000; }
        .log-value { color: #333333; font-weight: bold; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile responsive fixes */
        @media (max-width: 480px) {
            body { padding: 12px; }
            h1 { font-size: 1.25rem; }
            .config-panel { padding: 15px; }
            .config-panel p { word-break: break-word; }
            .config-panel code { word-break: break-all; }
            .config-row { grid-template-columns: 1fr; }
            .config-panel .btn { 
                display: block; 
                width: 100%; 
                margin: 8px 0; 
                margin-left: 0 !important;
            }
            .stats { grid-template-columns: 1fr 1fr; }
            .stat-value { font-size: 1.5rem; }
            .log-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            }
            .log-entry { 
                font-size: 0.75rem; 
                padding: 6px 8px;
                word-break: break-word;
            }
            #log { height: 350px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sensor Simulator Monitor</h1>
        <span id="status" class="status disconnected">Disconnected</span>
    </div>

    <div class="config-panel">
        <h3>MQTT Configuration</h3>
        <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">
            Connects to HiveMQ Cloud broker via WebSocket (port 8884). The Railway sensor simulator publishes to <code>demo/depot/dev/sensor/{assetId}/{metric}/data</code>.
        </p>
        <div class="config-row">
            <div class="config-field">
                <label>Topic (subscribe)</label>
                <input type="text" id="topic" value="demo/depot/dev/#" />
            </div>
            <div class="config-field">
                <label>Base Topic (for simulator)</label>
                <input type="text" id="baseTopicInput" value="demo/depot/dev" readonly style="background: #eee;" />
            </div>
        </div>
        <div style="margin-top: 15px;">
            <button id="connectBtn" class="btn btn-primary" onclick="toggleConnection()">Connect</button>
            <button class="btn btn-secondary" onclick="clearLog()">Clear Log</button>
            <button class="btn btn-secondary" onclick="subscribeToSimulatorTopics()" style="margin-left: 10px;">Subscribe to Simulator</button>
        </div>
    </div>
    
    <!-- Hidden config values - HiveMQ Cloud WebSocket connection -->
    <!-- Note: Port 8884 is for WSS (WebSocket Secure), Port 8883 is for MQTT over TLS -->
    <input type="hidden" id="broker" value="ba959be4d2874a21ae71690f1de8da95.s1.eu.hivemq.cloud" />
    <input type="hidden" id="port" value="8884" />
    <input type="hidden" id="username" value="chief" />
    <input type="hidden" id="password" value="Engineer1" />
    <input type="hidden" id="baseTopic" value="demo/depot/dev" />

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="msgCount">0</div>
            <div class="stat-label">Messages Received</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="tankCount">0</div>
            <div class="stat-label">Active Assets</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="lastUpdate">--:--:--</div>
            <div class="stat-label">Last Update</div>
        </div>
    </div>

    <div class="log-container">
        <div class="log-header">
            <h3>Live Message Log</h3>
            <label><input type="checkbox" id="autoScroll" checked /> Auto-scroll</label>
        </div>
        <div id="log"></div>
    </div>

    <script>
        let client = null;
        let connected = false;
        let messageCount = 0;
        let activeTanks = new Set();
        const baseTopic = document.getElementById('baseTopic')?.value || 'demo/depot/dev';

        function updateStatus(status, text) {
            const el = document.getElementById('status');
            el.className = 'status ' + status;
            el.textContent = text;
        }

        function toggleConnection() {
            if (connected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            const broker = document.getElementById('broker').value;
            const port = document.getElementById('port').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const topic = document.getElementById('topic').value;

            updateStatus('connecting', 'Connecting...');
            document.getElementById('connectBtn').textContent = 'Connecting...';

            const url = `wss://${broker}:${port}/mqtt`;
            
            addLog('system', `Connecting to HiveMQ Cloud via WebSocket...`, 'info');
            addLog('system', `URL: ${url}`, 'info');
            
            client = mqtt.connect(url, {
                username: username,
                password: password,
                protocol: 'wss',
                reconnectPeriod: 5000,
                connectTimeout: 30000,
                clean: true,
                clientId: 'web_monitor_' + Math.random().toString(16).substr(2, 8)
            });

            client.on('connect', () => {
                connected = true;
                updateStatus('connected', 'Connected');
                document.getElementById('connectBtn').textContent = 'Disconnect';
                document.getElementById('connectBtn').className = 'btn btn-danger';
                addLog('system', `Connected to HiveMQ Cloud broker`, 'info');
                
                // Subscribe to the sensor simulator topics
                // The Railway sensor simulator publishes to: {baseTopic}/sensor/{assetId}/{metric}/data
                const sensorTopic = `${baseTopic}/sensor/#`;
                
                client.subscribe(sensorTopic, { qos: 0 }, (err) => {
                    if (!err) {
                        addLog('system', `Subscribed to sensor data: ${sensorTopic}`, 'info');
                        addLog('system', `Waiting for data from Railway sensor simulator...`, 'info');
                    } else {
                        addLog('system', `Subscribe error: ${err.message}`, 'error');
                    }
                });
                
                // Also subscribe to the user-specified topic if different
                if (topic && topic !== sensorTopic && topic !== `${baseTopic}/#`) {
                    client.subscribe(topic, { qos: 0 }, (err) => {
                        if (!err) {
                            addLog('system', `Also subscribed to: ${topic}`, 'info');
                        }
                    });
                }
            });

            client.on('message', (topic, message) => {
                messageCount++;
                document.getElementById('msgCount').textContent = messageCount;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                try {
                    const data = JSON.parse(message.toString());
                    const parts = topic.split('/');
                    
                    // Topic structure from simulator: {baseTopic}/sensor/{assetId}/{metric}/data
                    // e.g., demo/depot/dev/sensor/TK-A04/level_mm/data
                    const sensorIndex = parts.indexOf('sensor');
                    let assetId = 'unknown';
                    let metric = 'unknown';
                    
                    if (sensorIndex >= 0 && parts.length > sensorIndex + 2) {
                        assetId = parts[sensorIndex + 1];
                        metric = parts[sensorIndex + 2];
                    }
                    
                    activeTanks.add(assetId);
                    document.getElementById('tankCount').textContent = activeTanks.size;

                    // Determine log type based on metric
                    let logType = 'info';
                    if (metric.includes('level')) logType = 'level';
                    else if (metric.includes('temp')) logType = 'temperature';
                    else if (metric.includes('pump') || metric.includes('motor')) logType = 'level';
                    
                    const valueStr = data.value !== undefined ? `${data.value} ${data.unit || ''}` : message.toString();
                    addLog(topic, `${assetId} â†’ ${metric}: ${valueStr}`, logType);
                } catch (e) {
                    // Non-JSON message
                    addLog(topic, message.toString(), 'info');
                }
            });

            client.on('error', (err) => {
                addLog('system', `Connection Error: ${err.message}`, 'error');
                updateStatus('disconnected', 'Error');
                console.error('MQTT Error:', err);
            });

            client.on('offline', () => {
                addLog('system', 'Client went offline', 'error');
            });

            client.on('reconnect', () => {
                addLog('system', 'Attempting to reconnect...', 'info');
                updateStatus('connecting', 'Reconnecting...');
            });

            client.on('close', () => {
                if (connected) {
                    connected = false;
                    updateStatus('disconnected', 'Disconnected');
                    document.getElementById('connectBtn').textContent = 'Connect';
                    document.getElementById('connectBtn').className = 'btn btn-primary';
                    addLog('system', 'Connection closed', 'error');
                }
            });
        }

        function disconnect() {
            if (client) {
                client.end();
                connected = false;
                updateStatus('disconnected', 'Disconnected');
                document.getElementById('connectBtn').textContent = 'Connect';
                document.getElementById('connectBtn').className = 'btn btn-primary';
            }
        }

        function addLog(topic, message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString();
            // Show a shorter topic path for readability
            const shortTopic = topic.split('/').slice(-3).join('/');
            entry.innerHTML = `<span class="log-time">${time}</span>` +
                            `<span class="log-topic">[${shortTopic}]</span> ` +
                            `<span class="log-value">${message}</span>`;
            
            log.appendChild(entry);
            
            // Keep only last 200 entries
            while (log.children.length > 200) {
                log.removeChild(log.firstChild);
            }
            
            if (document.getElementById('autoScroll').checked) {
                log.scrollTop = log.scrollHeight;
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            messageCount = 0;
            activeTanks.clear();
            document.getElementById('msgCount').textContent = '0';
            document.getElementById('tankCount').textContent = '0';
        }

        function subscribeToSimulatorTopics() {
            if (!connected || !client) {
                addLog('system', 'Not connected. Please connect first.', 'error');
                return;
            }
            
            // Subscribe to all sensor topics from the Railway simulator
            const topics = [
                `${baseTopic}/sensor/+/level_mm/data`,      // Tank levels
                `${baseTopic}/sensor/+/temperature/data`,   // Tank temperatures
                `${baseTopic}/sensor/+/pump_status/data`,   // Pump status
                `${baseTopic}/sensor/+/motor_current/data`  // Motor current
            ];
            
            topics.forEach(topic => {
                client.subscribe(topic, { qos: 0 }, (err) => {
                    if (!err) {
                        addLog('system', `Subscribed: ${topic}`, 'info');
                    } else {
                        addLog('system', `Failed to subscribe to ${topic}: ${err.message}`, 'error');
                    }
                });
            });
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            addLog('system', 'Sensor Simulator Monitor ready', 'info');
            addLog('system', 'Click "Connect" to receive data from Railway sensor simulator', 'info');
            addLog('system', `Expected topic pattern: ${baseTopic}/sensor/{assetId}/{metric}/data`, 'info');
        });
    </script>
</body>
</html>
